<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ åç«¯é›†æˆæµ‹è¯• - åµŒå…¥æ¨¡å‹ä¸æ–‡ä»¶ä¸Šä¼ </title>
    <link rel="stylesheet" href="style.css">
    <style>
        .test-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .status-indicator {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-weight: 500;
        }
        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .status-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status-warning {
            background: #fefce8;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .code-block {
            background: #1e293b;
            color: #f8fafc;
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.875rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .config-input {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
        <h1>ğŸ”§ åç«¯é›†æˆæµ‹è¯•</h1>
        <p>ä¸“é—¨æµ‹è¯•åµŒå…¥æ¨¡å‹å’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½çš„å®Œæ•´æµç¨‹</p>
        
        <!-- APIé…ç½® -->
        <div class="test-section">
            <h3>âš™ï¸ APIé…ç½®</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>åç«¯APIåœ°å€:</label>
                    <input type="text" id="api-base" value="http://localhost:8000" class="config-input">
                </div>
                <div>
                    <label>åµŒå…¥æ¨¡å‹APIåœ°å€:</label>
                    <input type="text" id="embed-url" value="http://192.168.196.151:9998" class="config-input">
                </div>
                <div>
                    <label>åµŒå…¥æ¨¡å‹åç§°:</label>
                    <input type="text" id="embed-model" value="bge-large-zh-v1.5" class="config-input">
                </div>
                <div>
                    <label>APIå¯†é’¥:</label>
                    <input type="text" id="embed-key" value="EMPTY" class="config-input">
                </div>
            </div>
            <button class="btn btn-secondary" onclick="updateBackendConfig()">
                <i class="fas fa-cog"></i> æ›´æ–°åç«¯é…ç½®
            </button>
        </div>

        <!-- åç«¯çŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>ğŸ¥ åç«¯çŠ¶æ€æ£€æŸ¥</h3>
            <button class="btn btn-primary" onclick="checkBackendHealth()">
                <i class="fas fa-heartbeat"></i> æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
            </button>
            <div id="health-status"></div>
        </div>

        <!-- åµŒå…¥æ¨¡å‹æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§  åµŒå…¥æ¨¡å‹æµ‹è¯•</h3>
            <p>æµ‹è¯•åµŒå…¥æ¨¡å‹APIè¿æ¥å’ŒåŠŸèƒ½</p>
            <button class="btn btn-primary" onclick="testEmbeddingModel()">
                <i class="fas fa-brain"></i> æµ‹è¯•åµŒå…¥æ¨¡å‹
            </button>
            <div id="embedding-test-result"></div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
            <p>æµ‹è¯•æ–‡ä»¶ä¸Šä¼ ã€æ–‡æœ¬æå–å’Œåˆ†å—å¤„ç†</p>
            
            <div class="form-group">
                <label for="test-kb-type">çŸ¥è¯†åº“åˆ†ç±»</label>
                <select id="test-kb-type" class="form-select">
                    <option value="ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£">ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£</option>
                    <option value="ä¸´åºŠè¯•éªŒæ–¹æ¡ˆ">ä¸´åºŠè¯•éªŒæ–¹æ¡ˆ</option>
                    <option value="åŒ»å­¦æ–‡çŒ®">åŒ»å­¦æ–‡çŒ®</option>
                </select>
            </div>
            
            <div class="drag-drop-area" id="test-drag-drop-area">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <p class="upload-hint">æµ‹è¯•æ–‡æœ¬æ–‡ä»¶ã€CSVæ–‡ä»¶ç­‰</p>
                <input type="file" id="test-file-input" multiple>
            </div>
            
            <button class="btn btn-primary" onclick="uploadTestFiles()" style="margin-top: 1rem;">
                <i class="fas fa-upload"></i> ä¸Šä¼ å¹¶æµ‹è¯•å¤„ç†
            </button>
            
            <div id="upload-test-result"></div>
        </div>

        <!-- çŸ¥è¯†åº“æŸ¥è¯¢æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ” çŸ¥è¯†åº“æŸ¥è¯¢æµ‹è¯•</h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="search-query" placeholder="è¾“å…¥æœç´¢å…³é”®è¯..." style="flex: 1;">
                <button class="btn btn-primary" onclick="testKnowledgeSearch()">
                    <i class="fas fa-search"></i> æœç´¢
                </button>
            </div>
            <div id="search-test-result"></div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="test-section">
            <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
            <button class="btn btn-secondary" onclick="loadKnowledgeStats()">
                <i class="fas fa-chart-bar"></i> åˆ·æ–°ç»Ÿè®¡
            </button>
            <div id="stats-display"></div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="test-section">
            <h3>ğŸ“‹ æ–‡ä»¶åˆ—è¡¨</h3>
            <button class="btn btn-secondary" onclick="loadFileList()">
                <i class="fas fa-list"></i> åˆ·æ–°åˆ—è¡¨
            </button>
            <div id="files-display"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentFiles = [];
        let apiBaseUrl = 'http://localhost:8000';

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUploadListeners();
            checkBackendHealth();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ ç›‘å¬å™¨
        function setupFileUploadListeners() {
            const dragDropArea = document.getElementById('test-drag-drop-area');
            const fileInput = document.getElementById('test-file-input');

            if (!dragDropArea || !fileInput) return;

            // ç§»é™¤æ—§äº‹ä»¶ç›‘å¬å™¨
            const newDragDropArea = dragDropArea.cloneNode(true);
            const newFileInput = newDragDropArea.querySelector('#test-file-input');
            dragDropArea.parentNode.replaceChild(newDragDropArea, dragDropArea);

            // æ‹–æ‹½äº‹ä»¶
            newDragDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                newDragDropArea.classList.add('dragover');
            });

            newDragDropArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!newDragDropArea.contains(e.relatedTarget)) {
                    newDragDropArea.classList.remove('dragover');
                }
            });

            newDragDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                newDragDropArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleTestFileSelect(files);
                }
            });

            // ç‚¹å‡»äº‹ä»¶
            newDragDropArea.addEventListener('click', (e) => {
                if (e.target !== newFileInput) {
                    newFileInput.click();
                }
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            newFileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    handleTestFileSelect(files);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleTestFileSelect(files) {
            currentFiles = Array.from(files);
            const dragDropArea = document.getElementById('test-drag-drop-area');
            const preview = dragDropArea.querySelector('p');
            
            if (currentFiles.length > 0) {
                const fileNames = currentFiles.map(f => f.name).join(', ');
                preview.innerHTML = `å·²é€‰æ‹© ${currentFiles.length} ä¸ªæ–‡ä»¶:<br><small style="color: #666;">${fileNames}</small>`;
                dragDropArea.style.borderColor = '#10b981';
                dragDropArea.style.backgroundColor = 'rgba(16, 185, 129, 0.05)';
            }
        }

        // æ›´æ–°åç«¯é…ç½®
        async function updateBackendConfig() {
            const embedUrl = document.getElementById('embed-url').value;
            const embedModel = document.getElementById('embed-model').value;
            const embedKey = document.getElementById('embed-key').value;
            apiBaseUrl = document.getElementById('api-base').value;

            try {
                const formData = new FormData();
                formData.append('embed_type', 'local-api');
                formData.append('embed_url', embedUrl);
                formData.append('embed_model', embedModel);
                formData.append('embed_key', embedKey);
                formData.append('embed_dimension', '1024');

                const response = await fetch(`${apiBaseUrl}/config/update`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showStatus('config-status', 'é…ç½®æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    showStatus('config-status', 'é…ç½®æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showStatus('config-status', `é…ç½®æ›´æ–°é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${apiBaseUrl}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    const statusHtml = `
                        <div class="status-success">
                            âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ<br>
                            <small>æœåŠ¡: ${data.service} | æ—¶é—´: ${data.timestamp}</small>
                        </div>
                    `;
                    document.getElementById('health-status').innerHTML = statusHtml;
                } else {
                    throw new Error('å¥åº·æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                const statusHtml = `
                    <div class="status-error">
                        âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥: ${error.message}
                    </div>
                `;
                document.getElementById('health-status').innerHTML = statusHtml;
            }
        }

        // æµ‹è¯•åµŒå…¥æ¨¡å‹
        async function testEmbeddingModel() {
            const resultDiv = document.getElementById('embedding-test-result');
            resultDiv.innerHTML = '<div class="status-warning">ğŸ”„ æ­£åœ¨æµ‹è¯•åµŒå…¥æ¨¡å‹...</div>';

            try {
                const response = await fetch(`${apiBaseUrl}/test/embedding`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    const resultHtml = `
                        <div class="status-success">
                            âœ… åµŒå…¥æ¨¡å‹æµ‹è¯•æˆåŠŸ<br>
                            <strong>æ¨¡å‹ç±»å‹:</strong> ${result.model_type}<br>
                            <strong>æ¨¡å‹åç§°:</strong> ${result.model_name || 'N/A'}<br>
                            <strong>å‘é‡ç»´åº¦:</strong> ${result.dimension}<br>
                            <strong>ç¤ºä¾‹å€¼:</strong> [${result.sample_values.join(', ')}]
                        </div>
                        <div class="code-block">
APIå“åº”: ${JSON.stringify(result, null, 2)}
                        </div>
                    `;
                    resultDiv.innerHTML = resultHtml;
                } else {
                    resultDiv.innerHTML = `
                        <div class="status-error">
                            âŒ åµŒå…¥æ¨¡å‹æµ‹è¯•å¤±è´¥<br>
                            <strong>é”™è¯¯ä¿¡æ¯:</strong> ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status-error">
                        âŒ æµ‹è¯•è¯·æ±‚å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // ä¸Šä¼ æµ‹è¯•æ–‡ä»¶
        async function uploadTestFiles() {
            if (currentFiles.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'warning');
                return;
            }

            const resultDiv = document.getElementById('upload-test-result');
            const knowledgeType = document.getElementById('test-kb-type').value;
            
            resultDiv.innerHTML = '<div class="status-warning">ğŸ”„ æ­£åœ¨ä¸Šä¼ å’Œå¤„ç†æ–‡ä»¶...</div>';

            try {
                let allResults = [];

                for (let file of currentFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('knowledge_type', knowledgeType);
                    formData.append('title', file.name.split('.')[0]);

                    const response = await fetch(`${apiBaseUrl}/knowledge/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    allResults.push({ file: file.name, result });
                }

                // æ˜¾ç¤ºç»“æœ
                let resultsHtml = '';
                for (let { file, result } of allResults) {
                    if (result.success) {
                        resultsHtml += `
                            <div class="status-success">
                                âœ… ${file} ä¸Šä¼ æˆåŠŸ<br>
                                <strong>è®°å½•æ•°:</strong> ${result.records_added}<br>
                                <strong>æ–‡æœ¬å—æ•°:</strong> ${result.chunks_count}<br>
                                <strong>æ–‡ä»¶ç±»å‹:</strong> ${result.processing_info.file_type}<br>
                                <strong>æ–‡æœ¬æå–:</strong> ${result.processing_info.text_extracted ? 'æˆåŠŸ' : 'å¤±è´¥'}<br>
                                <strong>åˆ†å—å¤„ç†:</strong> ${result.processing_info.chunking_applied ? 'å·²åº”ç”¨' : 'æœªåº”ç”¨'}
                            </div>
                        `;
                    } else {
                        resultsHtml += `
                            <div class="status-error">
                                âŒ ${file} ä¸Šä¼ å¤±è´¥: ${result.message || result.detail}
                            </div>
                        `;
                    }
                }

                resultDiv.innerHTML = resultsHtml;

                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                currentFiles = [];
                document.getElementById('test-file-input').value = '';
                const dragDropArea = document.getElementById('test-drag-drop-area');
                dragDropArea.querySelector('p').innerHTML = 'æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶';
                dragDropArea.style.borderColor = '';
                dragDropArea.style.backgroundColor = '';

                // åˆ·æ–°ç»Ÿè®¡å’Œæ–‡ä»¶åˆ—è¡¨
                loadKnowledgeStats();
                loadFileList();

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="status-error">
                        âŒ ä¸Šä¼ è¿‡ç¨‹å‡ºé”™: ${error.message}
                    </div>
                `;
            }
        }

        // æµ‹è¯•çŸ¥è¯†åº“æœç´¢
        async function testKnowledgeSearch() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
                return;
            }

            const resultDiv = document.getElementById('search-test-result');
            resultDiv.innerHTML = '<div class="status-warning">ğŸ”„ æ­£åœ¨è¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢...</div>';

            try {
                const response = await fetch(`${apiBaseUrl}/knowledge/search?query=${encodeURIComponent(query)}&top_k=5`);
                const result = await response.json();

                if (result.success) {
                    if (result.results.length > 0) {
                        let resultsHtml = `
                            <div class="status-success">
                                âœ… æ‰¾åˆ° ${result.results.length} ä¸ªç›¸å…³ç»“æœ
                            </div>
                        `;
                        
                        // æ˜¾ç¤ºæœç´¢ä¿¡æ¯
                        if (result.search_info) {
                            resultsHtml += `
                                <div style="background: #f1f5f9; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                    <h4>ğŸ” æœç´¢è¯¦æƒ…</h4>
                                    <p><strong>æŸ¥è¯¢:</strong> ${result.search_info.query}</p>
                                    <p><strong>æœç´¢çš„æ–‡æ¡£æ•°:</strong> ${result.search_info.total_docs_searched}</p>
                                    <p><strong>æ‰¾åˆ°ç»“æœæ•°:</strong> ${result.search_info.results_found}</p>
                                    <p><strong>æŸ¥è¯¢å‘é‡ç»´åº¦:</strong> ${result.search_info.embedding_dimension}</p>
                                </div>
                            `;
                        }
                        
                        result.results.forEach((item, index) => {
                            const similarityPercent = (item.score * 100).toFixed(1);
                            const similarityColor = item.score > 0.7 ? '#10b981' : item.score > 0.5 ? '#f59e0b' : '#ef4444';
                            
                            resultsHtml += `
                                <div style="border: 1px solid #e2e8f0; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <h4>ç»“æœ ${index + 1}</h4>
                                        <span style="background: ${similarityColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">
                                            ç›¸ä¼¼åº¦: ${similarityPercent}%
                                        </span>
                                    </div>
                                    <p><strong>ç±»å‹:</strong> ${item.knowledge_type}</p>
                                    <p><strong>å†…å®¹:</strong> ${item.content}</p>
                                    <div style="font-size: 0.875rem; color: #64748b;">
                                        <p><strong>æ¥æº:</strong> ${item.metadata.source_file || item.metadata.title}</p>
                                        <p><strong>æ–‡æœ¬å—:</strong> ç¬¬ ${item.metadata.chunk_index + 1} å—</p>
                                        <p><strong>ä¸Šä¼ æ—¶é—´:</strong> ${new Date(item.metadata.upload_time).toLocaleString()}</p>
                                        ${item.metadata.embedding_dimension ? `<p><strong>å‘é‡ç»´åº¦:</strong> ${item.metadata.embedding_dimension}</p>` : ''}
                                    </div>
                                </div>
                            `;
                        });

                        resultDiv.innerHTML = resultsHtml;
                    } else {
                        let messageHtml = '<div class="status-warning">âš ï¸ æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
                        
                        if (result.message) {
                            messageHtml += `<p>${result.message}</p>`;
                        }
                        
                        if (result.search_info) {
                            messageHtml += `
                                <div style="background: #fef3c7; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                    <p><strong>æœç´¢ä¿¡æ¯:</strong></p>
                                    <p>â€¢ æŸ¥è¯¢: ${result.search_info.query}</p>
                                    <p>â€¢ æœç´¢çš„æ–‡æ¡£æ•°: ${result.search_info.total_docs_searched}</p>
                                    <p>â€¢ æŸ¥è¯¢å‘é‡ç»´åº¦: ${result.search_info.embedding_dimension}</p>
                                </div>
                            `;
                        }
                        
                        resultDiv.innerHTML = messageHtml;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="status-error">âŒ æœç´¢å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status-error">âŒ æœç´¢è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½çŸ¥è¯†åº“ç»Ÿè®¡
        async function loadKnowledgeStats() {
            try {
                const response = await fetch(`${apiBaseUrl}/knowledge/stats`);
                const result = await response.json();

                if (result.success) {
                    let statsHtml = '<div class="status-success">âœ… ç»Ÿè®¡ä¿¡æ¯åŠ è½½æˆåŠŸ</div>';
                    
                    // æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡
                    if (result.summary) {
                        statsHtml += `
                            <div style="background: #f1f5f9; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                <h4>ğŸ“Š æ€»ä½“ç»Ÿè®¡</h4>
                                <p><strong>å‘é‡åŒ–æ–‡æ¡£æ€»æ•°:</strong> ${result.summary.total_embedded_documents}</p>
                                <p><strong>ä¸Šä¼ æ–‡ä»¶æ€»æ•°:</strong> ${result.summary.total_uploaded_files}</p>
                                <p><strong>åµŒå…¥æ¨¡å‹ç±»å‹:</strong> ${result.summary.embedding_model}</p>
                                <p><strong>å¹³å‡æ¯æ–‡ä»¶æ–‡æ¡£æ•°:</strong> ${result.summary.avg_docs_per_file.toFixed(1)}</p>
                            </div>
                        `;
                    }
                    
                    // æ˜¾ç¤ºå„ç±»å‹ç»Ÿè®¡
                    const total = Object.values(result.stats).reduce((sum, stat) => sum + (stat.document_count || 0), 0);
                    statsHtml += `<h4>ğŸ“š åˆ†ç±»ç»Ÿè®¡</h4>`;
                    
                    Object.entries(result.stats).forEach(([type, stat]) => {
                        const count = stat.document_count || 0;
                        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                        statsHtml += `
                            <p><strong>${type}:</strong> ${count} ä¸ªæ–‡æ¡£ (${percentage}%)</p>
                        `;
                    });

                    document.getElementById('stats-display').innerHTML = statsHtml;
                } else {
                    document.getElementById('stats-display').innerHTML = '<div class="status-error">âŒ ç»Ÿè®¡åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                document.getElementById('stats-display').innerHTML = `<div class="status-error">âŒ ç»Ÿè®¡è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFileList() {
            try {
                const response = await fetch(`${apiBaseUrl}/knowledge/files`);
                const result = await response.json();

                if (result.success) {
                    let filesHtml = `
                        <div class="status-success">
                            âœ… æ–‡ä»¶åˆ—è¡¨åŠ è½½æˆåŠŸ 
                            (å…± ${result.files.length} ä¸ªæ–‡ä»¶ï¼Œ${result.total_embedded_documents || 0} ä¸ªå‘é‡æ–‡æ¡£)
                        </div>
                    `;
                    
                    if (result.files.length > 0) {
                        result.files.forEach(file => {
                            const embeddingStatus = file.embedded_count > 0 ? 'âœ…' : 'âŒ';
                            const embeddingInfo = file.embedded_count > 0 ? 
                                `æˆåŠŸ: ${file.embedded_count}/${file.chunks_count}` : 
                                'æœªå‘é‡åŒ–';
                            
                            filesHtml += `
                                <div style="border: 1px solid #e2e8f0; padding: 1rem; margin: 0.5rem 0; border-radius: 6px;">
                                    <h4>${file.original_name || file.filename}</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                        <div>
                                            <p><strong>ç±»å‹:</strong> ${file.knowledge_type}</p>
                                            <p><strong>å¤§å°:</strong> ${formatFileSize(file.size)}</p>
                                            <p><strong>æ–‡æœ¬å—æ•°:</strong> ${file.chunks_count || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p><strong>å‘é‡åŒ–:</strong> ${embeddingStatus} ${embeddingInfo}</p>
                                            <p><strong>ä¸Šä¼ æ—¶é—´:</strong> ${new Date(file.upload_time).toLocaleString()}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        filesHtml += '<p>æš‚æ— ä¸Šä¼ çš„æ–‡ä»¶</p>';
                    }

                    document.getElementById('files-display').innerHTML = filesHtml;
                } else {
                    document.getElementById('files-display').innerHTML = '<div class="status-error">âŒ æ–‡ä»¶åˆ—è¡¨åŠ è½½å¤±è´¥</div>';
                }
            } catch (error) {
                document.getElementById('files-display').innerHTML = `<div class="status-error">âŒ æ–‡ä»¶åˆ—è¡¨è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status-${type}">${message}</div>`;
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Toastæç¤º
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; color: #64748b; font-size: 1.2rem; padding: 0 5px;">Ã—</button>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html> 